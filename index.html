<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Pastel Kanban</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{--bg:#f9f6ef;--text:#1b1b1f;--muted:#6f6f76;--card:#fff;--radius:14px;--ring:0 0 0 2px rgba(0,0,0,0.06);--design:258,100%,86%;--dev:174,70%,80%;--research:44,100%,84%;--bug:0,100%,82%;--chore:200,100%,85%}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";color:var(--text);background:radial-gradient(1200px 800px at 20% -10%,rgba(255,255,255,0.8),transparent),radial-gradient(1000px 700px at 100% 20%,hsla(var(--design),0.25),transparent),radial-gradient(900px 600px at -10% 100%,hsla(var(--dev),0.25),transparent),var(--bg)}

/* ===================== EVERYTHING ABOVE THIS LINE UNCHANGED ===================== */

/* ============== NEW COLOR PICKER (2D FIELD) ============== */
.picker-backdrop{
 position:fixed;
 inset:0;
 background:rgba(0,0,0,0.2);
 z-index:10000;
 display:none
}
.picker-backdrop.active{display:block}

.color-picker-popup{
 position:fixed;
 top:50%;
 left:50%;
 transform:translate(-50%,-50%);
 background:#fff;
 border-radius:18px;
 padding:20px;
 box-shadow:0 20px 60px rgba(0,0,0,0.25);
 z-index:10001;
 display:none;
 width:320px;
}
.color-picker-popup.active{display:block}

/* Big preview (matches cards) */
.color-preview-large{
 width:100%;
 height:70px;
 border-radius:16px;
 border:1px solid rgba(0,0,0,0.06);
 margin-bottom:14px;
 box-shadow:0 0 0 1px rgba(255,255,255,0.5) inset,
            0 10px 30px rgba(0,0,0,0.18);
}

/* Hex input */
.hex-input-container{
 display:flex;
 gap:8px;
 align-items:center;
 margin-bottom:14px;
}
.hex-input-container label{font-size:13px;color:var(--muted)}
.hex-input{
 flex:1;
 height:36px;
 border-radius:10px;
 border:1px solid rgba(0,0,0,0.08);
 padding:0 12px;
 font-family:monospace;
 font-size:13px;
}

/* ---- THE COLOR FIELD (now softer + pastel) ---- */
.color-field-wrapper{
 position:relative;
 width:100%;
 aspect-ratio: 1 / 1;
 border-radius:16px;
 overflow:hidden;
 border:1px solid rgba(0,0,0,0.08);
 box-shadow:0 4px 12px rgba(0,0,0,0.06) inset;
 margin-bottom:16px;
 cursor:crosshair;
 background:#fffaf5;
}

/* Hue left → right (reduced saturation, lighter base) */
.color-field{
 position:absolute;
 inset:0;
 background:
   linear-gradient(to right,
     hsl(0,55%,72%),
     hsl(60,55%,72%),
     hsl(120,55%,72%),
     hsl(180,55%,72%),
     hsl(240,55%,72%),
     hsl(300,55%,72%),
     hsl(360,55%,72%)
   );
}

/* Lightness top → bottom (much gentler, no harsh black) */
.color-field::after{
 content:"";
 position:absolute;
 inset:0;
 background:linear-gradient(
   to bottom,
   rgba(255,255,255,0.85),
   rgba(0,0,0,0.35)
 );
 mix-blend-mode:multiply;
}

/* Soft pastel thumb (bigger + halo so it reads cleanly) */
.color-thumb{
 position:absolute;
 width:24px;
 height:24px;
 border-radius:50%;
 border:2px solid rgba(0,0,0,0.25);
 background:#ffffff;
 transform:translate(-50%,-50%);
 pointer-events:none;
 box-shadow:
   0 0 0 2px rgba(255,255,255,0.8),
   0 2px 6px rgba(0,0,0,0.25);
}

/* Buttons */
.picker-actions{
 display:flex;
 justify-content:center;
 gap:10px;
}

/* ===================== END OF VISUAL CHANGES ===================== */
</style>
</head>

<body>
<header class="app-header">
 <div class="legend-wrap">
   <div class="legend">
     <span class="chip cat-design">Design</span>
     <span class="chip cat-dev">Dev</span>
     <span class="chip cat-research">Research</span>
     <span class="chip cat-bug">Bug</span>
     <span class="chip cat-chore">Chore</span>
   </div>
   <button class="legend-plus" id="open-colors">＋</button>
 </div>
</header>

<main class="board" id="board">
<!-- Columns (unchanged structure) -->
<section class="column" data-col="todo"><header><h2>To Do</h2></header>
<form class="quick-add" data-target="todo">
<input type="text" name="title" placeholder="Add a task…"/>
<div class="category-select">
 <button type="button" class="category-button"><span class="selected-category">Dev</span></button>
 <div class="category-dropdown">
   <div class="category-option" data-value="design">Design</div>
   <div class="category-option" data-value="dev">Dev</div>
   <div class="category-option" data-value="research">Research</div>
   <div class="category-option" data-value="bug">Bug</div>
   <div class="category-option" data-value="chore">Chore</div>
 </div>
</div>
<button type="submit">＋</button>
</form>
<div class="cards" data-list="todo"></div>
</section>

<section class="column" data-col="next"><header><h2>Do Next</h2></header>
<form class="quick-add" data-target="next">
<input type="text" name="title" placeholder="Add a task…"/>
<div class="category-select">
 <button type="button" class="category-button"><span class="selected-category">Dev</span></button>
 <div class="category-dropdown">
   <div class="category-option" data-value="design">Design</div>
   <div class="category-option" data-value="dev">Dev</div>
   <div class="category-option" data-value="research">Research</div>
   <div class="category-option" data-value="bug">Bug</div>
   <div class="category-option" data-value="chore">Chore</div>
 </div>
</div>
<button type="submit">＋</button>
</form>
<div class="cards" data-list="next"></div>
</section>

<section class="column" data-col="doing"><header><h2>Doing</h2></header>
<form class="quick-add" data-target="doing">
<input type="text" name="title" placeholder="Add a task…"/>
<div class="category-select">
 <button type="button" class="category-button"><span class="selected-category">Dev</span></button>
 <div class="category-dropdown">
   <div class="category-option" data-value="design">Design</div>
   <div class="category-option" data-value="dev">Dev</div>
   <div class="category-option" data-value="research">Research</div>
   <div class="category-option" data-value="bug">Bug</div>
   <div class="category-option" data-value="chore">Chore</div>
 </div>
</div>
<button type="submit">＋</button>
</form>
<div class="cards" data-list="doing"></div>
</section>

<section class="column" data-col="done"><header><h2>Done</h2></header>
<form class="quick-add" data-target="done">
<input type="text" name="title" placeholder="Add a task…"/>
<div class="category-select">
 <button type="button" class="category-button"><span class="selected-category">Dev</span></button>
 <div class="category-dropdown">
   <div class="category-option" data-value="design">Design</div>
   <div class="category-option" data-value="dev">Dev</div>
   <div class="category-option" data-value="research">Research</div>
   <div class="category-option" data-value="bug">Bug</div>
   <div class="category-option" data-value="chore">Chore</div>
 </div>
</div>
<button type="submit">＋</button>
</form>
<div class="cards" data-list="done"></div>
</section>
</main>

<template id="card-template">
 <article class="card" draggable="true">
   <div class="card-top"><button class="icon-button del">✕</button></div>
   <div class="title" contenteditable="true" spellcheck="false"></div>
 </article>
</template>

<!-- CATEGORY MODAL -->
<div class="modal-backdrop" id="color-modal">
 <div class="modal">
   <h3>Customize Categories</h3>
   <div class="color-grid">
     <div class="color-row"><input type="text" class="category-name-input" data-category="design" value="Design"/><div class="color-preview cat-design" data-category="design"></div></div>
     <div class="color-row"><input type="text" class="category-name-input" data-category="dev" value="Dev"/><div class="color-preview cat-dev" data-category="dev"></div></div>
     <div class="color-row"><input type="text" class="category-name-input" data-category="research" value="Research"/><div class="color-preview cat-research" data-category="research"></div></div>
     <div class="color-row"><input type="text" class="category-name-input" data-category="bug" value="Bug"/><div class="color-preview cat-bug" data-category="bug"></div></div>
     <div class="color-row"><input type="text" class="category-name-input" data-category="chore" value="Chore"/><div class="color-preview cat-chore" data-category="chore"></div></div>
   </div>
   <div class="modal-actions">
     <button class="btn" id="cancel-colors">Cancel</button>
     <button class="btn primary" id="save-colors">Save</button>
   </div>
 </div>
</div>

<!-- NEW COLOR PICKER -->
<div class="picker-backdrop" id="picker-backdrop"></div>

<div class="color-picker-popup" id="color-picker-popup">
 <div class="color-preview-large" id="color-preview-large"></div>

 <div class="hex-input-container">
   <label>#</label>
   <input type="text" class="hex-input" id="hex-input" maxlength="6" placeholder="FFFFFF">
 </div>

 <div class="color-field-wrapper" id="color-field-wrapper">
   <div class="color-field" id="color-field"></div>
   <div class="color-thumb" id="color-thumb"></div>
 </div>

 <div class="picker-actions">
   <button class="btn" id="picker-cancel">Cancel</button>
   <button class="btn primary" id="picker-save">Save</button>
 </div>
</div>

<script>
/* ===================== STATE & RENDER (UNCHANGED LOGIC) ===================== */
const K='flowboard:v1',
dCat=[
{id:'design',name:'Design',color:'#e6d5ff'},
{id:'dev',name:'Dev',color:'#b3f5e8'},
{id:'research',name:'Research',color:'#fff4b3'},
{id:'bug',name:'Bug',color:'#ffc7c7'},
{id:'chore',name:'Chore',color:'#b3e5ff'}
];

function load(){try{const r=localStorage.getItem(K);return r?JSON.parse(r):null}catch(e){return null}}
const state=load()||{columns:{todo:[],next:[],doing:[],done:[]},colors:null,categories:dCat},
board=document.getElementById('board'),
tpl=document.getElementById('card-template');

function save(){localStorage.setItem(K,JSON.stringify(state))}
function uid(){return Math.random().toString(36).slice(2,9)}

function render(){
['todo','next','doing','done'].forEach(c=>{
 const l=board.querySelector(`[data-list="${c}"]`);
 l.innerHTML='';
 state.columns[c].forEach(card=>l.appendChild(renderCard(card)));
});
}

function renderCard(c){
const n=tpl.content.firstElementChild.cloneNode(true);
n.dataset.id=c.id;
n.classList.add(`cat-${c.category}`);
const t=n.querySelector('.title');
t.textContent=c.title;
t.addEventListener('input',()=>updateCard(c.id,{title:t.textContent.trim()}));
n.querySelector('.del').addEventListener('click',()=>removeCard(c.id));
n.addEventListener('dragstart',e=>onDragStart(e,c.id));
n.addEventListener('dragend',onDragEnd);
return n;
}

/* ===================== NEW 2D PICKER LOGIC (ONLY CLAMPING CHANGED) ===================== */
const pickerPopup=document.getElementById('color-picker-popup'),
pickerBackdrop=document.getElementById('picker-backdrop'),
colorField=document.getElementById('color-field-wrapper'),
colorThumb=document.getElementById('color-thumb'),
hexInput=document.getElementById('hex-input'),
colorPreviewLarge=document.getElementById('color-preview-large'),
pickerCancel=document.getElementById('picker-cancel'),
pickerSave=document.getElementById('picker-save');

let currentCategory=null;
let currentHue=0;
let currentLightness=80;
let dragging=false;

function updatePreviewFromHSL(h,l){
const hex=hslToHex(h,70,l);
hexInput.value=hex.replace('#','').toUpperCase();

const {h:hh,s, l:ll}=hexToHsl(hex);
colorPreviewLarge.style.background=`hsla(${hh},${s}%,${ll}%,0.22)`;
colorPreviewLarge.style.boxShadow=
   `0 0 0 1px hsla(${hh},${s}%,${ll}%,0.55) inset,`+
   `0 10px 30px hsla(${hh},${s}%,${ll}%,0.35)`;

if(currentCategory) tempColors[currentCategory]=hex;
}

/* Move thumb and update color (NOW PROPERLY CLAMPED) */
function setFromPosition(x,y){
const rect=colorField.getBoundingClientRect();
const r = colorThumb.offsetWidth / 2;

const clampedX = Math.max(r, Math.min(rect.width - r, x));
const clampedY = Math.max(r, Math.min(rect.height - r, y));

const hue=Math.round((clampedX/rect.width)*360);
const light=Math.round((1 - clampedY/rect.height)*100);

currentHue=hue;
currentLightness=light;

colorThumb.style.left=clampedX+'px';
colorThumb.style.top=clampedY+'px';

updatePreviewFromHSL(hue,light);
}

colorField.addEventListener('mousedown',e=>{
dragging=true;
const rect=colorField.getBoundingClientRect();
setFromPosition(e.clientX-rect.left, e.clientY-rect.top);
});

document.addEventListener('mousemove',e=>{
if(!dragging) return;
const rect=colorField.getBoundingClientRect();
setFromPosition(e.clientX-rect.left, e.clientY-rect.top);
});

document.addEventListener('mouseup',()=>dragging=false);

/* --- Show picker at existing color --- */
function showColorPicker(cat,hex){
currentCategory=cat;
const {h,l}=hexToHsl(hex);

const rect=colorField.getBoundingClientRect();
const r = colorThumb.offsetWidth / 2;
const x = Math.max(r, Math.min(rect.width - r, (h/360)*rect.width));
const y = Math.max(r, Math.min(rect.height - r, (1 - l/100)*rect.height));

colorThumb.style.left=x+'px';
colorThumb.style.top=y+'px';

updatePreviewFromHSL(h,l);
pickerPopup.classList.add('active');
pickerBackdrop.classList.add('active');
}

/* --- Hide picker --- */
function hideColorPicker(){
pickerPopup.classList.remove('active');
pickerBackdrop.classList.remove('active');
currentCategory=null;
}

/* Hex input live update (keeps thumb in bounds) */
hexInput.addEventListener('input',e=>{
let v=e.target.value.replace(/[^0-9a-fA-F]/g,'').toUpperCase();
if(v.length>6)v=v.slice(0,6);
e.target.value=v;
if(v.length===6){
 const hex='#'+v;
 const{h,l}=hexToHsl(hex);
 const rect=colorField.getBoundingClientRect();
 const r = colorThumb.offsetWidth / 2;

 const x = Math.max(r, Math.min(rect.width - r, (h/360)*rect.width));
 const y = Math.max(r, Math.min(rect.height - r, (1-l/100)*rect.height));

 colorThumb.style.left=x+'px';
 colorThumb.style.top=y+'px';
 updatePreviewFromHSL(h,l);
}
});

pickerCancel.addEventListener('click',hideColorPicker);
pickerSave.addEventListener('click',hideColorPicker);
pickerBackdrop.addEventListener('click',hideColorPicker);

@media (max-width:900px){.board{grid-template-columns:1fr}}
</style>
</head>

<body>
<header class="app-header">
  <div class="legend-wrap">
    <div class="legend">
      <span class="chip cat-design">Design</span>
      <span class="chip cat-dev">Dev</span>
      <span class="chip cat-research">Research</span>
      <span class="chip cat-bug">Bug</span>
      <span class="chip cat-chore">Chore</span>
    </div>
    <button class="legend-plus" id="open-colors">＋</button>
  </div>
</header>

<main class="board" id="board">
<!-- Columns (unchanged structure) -->
<section class="column" data-col="todo"><header><h2>To Do</h2></header>
<form class="quick-add" data-target="todo">
<input type="text" name="title" placeholder="Add a task…"/>
<div class="category-select">
  <button type="button" class="category-button"><span class="selected-category">Dev</span></button>
  <div class="category-dropdown">
    <div class="category-option" data-value="design">Design</div>
    <div class="category-option" data-value="dev">Dev</div>
    <div class="category-option" data-value="research">Research</div>
    <div class="category-option" data-value="bug">Bug</div>
    <div class="category-option" data-value="chore">Chore</div>
  </div>
</div>
<button type="submit">＋</button>
</form>
<div class="cards" data-list="todo"></div>
</section>

<section class="column" data-col="next"><header><h2>Do Next</h2></header>
<form class="quick-add" data-target="next">
<input type="text" name="title" placeholder="Add a task…"/>
<div class="category-select">
  <button type="button" class="category-button"><span class="selected-category">Dev</span></button>
  <div class="category-dropdown">
    <div class="category-option" data-value="design">Design</div>
    <div class="category-option" data-value="dev">Dev</div>
    <div class="category-option" data-value="research">Research</div>
    <div class="category-option" data-value="bug">Bug</div>
    <div class="category-option" data-value="chore">Chore</div>
  </div>
</div>
<button type="submit">＋</button>
</form>
<div class="cards" data-list="next"></div>
</section>

<section class="column" data-col="doing"><header><h2>Doing</h2></header>
<form class="quick-add" data-target="doing">
<input type="text" name="title" placeholder="Add a task…"/>
<div class="category-select">
  <button type="button" class="category-button"><span class="selected-category">Dev</span></button>
  <div class="category-dropdown">
    <div class="category-option" data-value="design">Design</div>
    <div class="category-option" data-value="dev">Dev</div>
    <div class="category-option" data-value="research">Research</div>
    <div class="category-option" data-value="bug">Bug</div>
    <div class="category-option" data-value="chore">Chore</div>
  </div>
</div>
<button type="submit">＋</button>
</form>
<div class="cards" data-list="doing"></div>
</section>

<section class="column" data-col="done"><header><h2>Done</h2></header>
<form class="quick-add" data-target="done">
<input type="text" name="title" placeholder="Add a task…"/>
<div class="category-select">
  <button type="button" class="category-button"><span class="selected-category">Dev</span></button>
  <div class="category-dropdown">
    <div class="category-option" data-value="design">Design</div>
    <div class="category-option" data-value="dev">Dev</div>
    <div class="category-option" data-value="research">Research</div>
    <div class="category-option" data-value="bug">Bug</div>
    <div class="category-option" data-value="chore">Chore</div>
  </div>
</div>
<button type="submit">＋</button>
</form>
<div class="cards" data-list="done"></div>
</section>
</main>

<template id="card-template">
  <article class="card" draggable="true">
    <div class="card-top"><button class="icon-button del">✕</button></div>
    <div class="title" contenteditable="true" spellcheck="false"></div>
  </article>
</template>

<!-- CATEGORY MODAL -->
<div class="modal-backdrop" id="color-modal">
  <div class="modal">
    <h3>Customize Categories</h3>
    <div class="color-grid">
      <div class="color-row"><input type="text" class="category-name-input" data-category="design" value="Design"/><div class="color-preview cat-design" data-category="design"></div></div>
      <div class="color-row"><input type="text" class="category-name-input" data-category="dev" value="Dev"/><div class="color-preview cat-dev" data-category="dev"></div></div>
      <div class="color-row"><input type="text" class="category-name-input" data-category="research" value="Research"/><div class="color-preview cat-research" data-category="research"></div></div>
      <div class="color-row"><input type="text" class="category-name-input" data-category="bug" value="Bug"/><div class="color-preview cat-bug" data-category="bug"></div></div>
      <div class="color-row"><input type="text" class="category-name-input" data-category="chore" value="Chore"/><div class="color-preview cat-chore" data-category="chore"></div></div>
    </div>
    <div class="modal-actions">
      <button class="btn" id="cancel-colors">Cancel</button>
      <button class="btn primary" id="save-colors">Save</button>
    </div>
  </div>
</div>

<!-- NEW COLOR PICKER -->
<div class="picker-backdrop" id="picker-backdrop"></div>

<div class="color-picker-popup" id="color-picker-popup">
  <div class="color-preview-large" id="color-preview-large"></div>

  <div class="hex-input-container">
    <label>#</label>
    <input type="text" class="hex-input" id="hex-input" maxlength="6" placeholder="FFFFFF">
  </div>

  <div class="color-field-wrapper" id="color-field-wrapper">
    <div class="color-field" id="color-field"></div>
    <div class="color-thumb" id="color-thumb"></div>
  </div>

  <div class="picker-actions">
    <button class="btn" id="picker-cancel">Cancel</button>
    <button class="btn primary" id="picker-save">Save</button>
  </div>
</div>

<script>
/* ===================== STATE & RENDER (UNCHANGED LOGIC) ===================== */
const K='flowboard:v1',
dCat=[
 {id:'design',name:'Design',color:'#e6d5ff'},
 {id:'dev',name:'Dev',color:'#b3f5e8'},
 {id:'research',name:'Research',color:'#fff4b3'},
 {id:'bug',name:'Bug',color:'#ffc7c7'},
 {id:'chore',name:'Chore',color:'#b3e5ff'}
];

function load(){try{const r=localStorage.getItem(K);return r?JSON.parse(r):null}catch(e){return null}}
const state=load()||{columns:{todo:[],next:[],doing:[],done:[]},colors:null,categories:dCat},
board=document.getElementById('board'),
tpl=document.getElementById('card-template');

function save(){localStorage.setItem(K,JSON.stringify(state))}
function uid(){return Math.random().toString(36).slice(2,9)}

function render(){
 ['todo','next','doing','done'].forEach(c=>{
  const l=board.querySelector(`[data-list="${c}"]`);
  l.innerHTML='';
  state.columns[c].forEach(card=>l.appendChild(renderCard(card)));
 });
}

function renderCard(c){
 const n=tpl.content.firstElementChild.cloneNode(true);
 n.dataset.id=c.id;
 n.classList.add(`cat-${c.category}`);
 const t=n.querySelector('.title');
 t.textContent=c.title;
 t.addEventListener('input',()=>updateCard(c.id,{title:t.textContent.trim()}));
 n.querySelector('.del').addEventListener('click',()=>removeCard(c.id));
 n.addEventListener('dragstart',e=>onDragStart(e,c.id));
 n.addEventListener('dragend',onDragEnd);
 return n;
}

function addCard(col,title,cat){
 const t=(title||'').trim();
 if(!t)return;
 state.columns[col].push({id:uid(),title:t,category:cat});
 save();render();
}

function updateCard(id,p){
 for(const c of['todo','next','doing','done']){
  const i=state.columns[c].findIndex(x=>x.id===id);
  if(i!==-1){state.columns[c][i]={...state.columns[c][i],...p};save();return}
 }
}

function removeCard(id){
 for(const c of['todo','next','doing','done']){
  const b=state.columns[c].length;
  state.columns[c]=state.columns[c].filter(x=>x.id!==id);
  if(state.columns[c].length!==b)break;
 }
 save();render();
}

/* --- Drag & drop (unchanged) --- */
let dragData=null;
function onDragStart(e,id){
 const c=e.target;
 e.dataTransfer.effectAllowed='move';
 e.dataTransfer.setData('text/plain',id);
 dragData={id,startCol:c.closest('.column').dataset.col,card:c};
 setTimeout(()=>c.style.opacity='0',0);
 c.classList.add('dragging');
}
function onDragEnd(){
 if(dragData&&dragData.card){
  dragData.card.style.opacity='';
  dragData.card.classList.remove('dragging');
 }
 dragData=null;
 document.querySelectorAll('.drag-over').forEach(e=>e.classList.remove('drag-over'));
}
document.querySelectorAll('.column').forEach(col=>{
 col.addEventListener('dragover',e=>{e.preventDefault();col.classList.add('drag-over')});
 col.addEventListener('dragleave',()=>col.classList.remove('drag-over'));
 col.addEventListener('drop',e=>{
  e.preventDefault();e.stopPropagation();
  col.classList.remove('drag-over');
  const l=col.querySelector('.cards'),
  to=l.dataset.list,
  id=e.dataTransfer.getData('text/plain')||(dragData&&dragData.id);
  if(id)moveCard(id,to,state.columns[to].length);
 });
});

/* --- Category dropdown --- */
document.querySelectorAll('.category-button').forEach(b=>{
 const d=b.nextElementSibling;
 b.addEventListener('click',e=>{
  e.stopPropagation();
  document.querySelectorAll('.category-dropdown').forEach(x=>{if(x!==d)x.classList.remove('open')});
  d.classList.toggle('open');
 });
 d.querySelectorAll('.category-option').forEach(o=>o.addEventListener('click',e=>{
  e.stopPropagation();
  b.querySelector('.selected-category').textContent=o.textContent;
  b.dataset.selectedCategory=o.dataset.value;
  d.classList.remove('open');
 }));
});
document.addEventListener('click',()=>document.querySelectorAll('.category-dropdown').forEach(d=>d.classList.remove('open')));

/* ===================== COLOR UTILS ===================== */
function getCSSVar(n){return getComputedStyle(document.documentElement).getPropertyValue(n).trim()}
function setCSSVar(n,v){document.documentElement.style.setProperty(n,v)}

function hslToHex(h,s,l){
 s/=100;l/=100;
 const k=n=>(n+h/30)%12,
 a=s*Math.min(l,1-l),
 f=n=>l-a*Math.max(-1,Math.min(k(n)-3,Math.min(9-k(n),1))),
 toHex=x=>Math.round(255*x).toString(16).padStart(2,'0');
 return`#${toHex(f(0))}${toHex(f(8))}${toHex(f(4))}`;
}

function hexToHsl(hex){
 let r=0,g=0,b=0;
 hex=hex.replace('#','');
 if(hex.length===3){
  r=parseInt(hex[0]+hex[0],16);
  g=parseInt(hex[1]+hex[1],16);
  b=parseInt(hex[2]+hex[2],16);
 } else{
  r=parseInt(hex.substring(0,2),16);
  g=parseInt(hex.substring(2,4),16);
  b=parseInt(hex.substring(4,6),16);
 }
 r/=255;g/=255;b/=255;
 const max=Math.max(r,g,b),min=Math.min(r,g,b);
 let h,s,l=(max+min)/2;
 if(max===min){h=0;s=0}
 else{
  const d=max-min;
  s=l>0.5?d/(2-max-min):d/(max+min);
  switch(max){
   case r:h=(g-b)/d+(g<b?6:0);break;
   case g:h=(b-r)/d+2;break;
   case b:h=(r-g)/d+4;break;
  }
  h*=60;
 }
 return{h:Math.round(h),s:Math.round(s*100),l:Math.round(l*100)};
}

/* ===================== NEW 2D PICKER LOGIC ===================== */
const pickerPopup=document.getElementById('color-picker-popup'),
pickerBackdrop=document.getElementById('picker-backdrop'),
colorField=document.getElementById('color-field-wrapper'),
colorThumb=document.getElementById('color-thumb'),
hexInput=document.getElementById('hex-input'),
colorPreviewLarge=document.getElementById('color-preview-large'),
pickerCancel=document.getElementById('picker-cancel'),
pickerSave=document.getElementById('picker-save');

let currentCategory=null;
let currentHue=0;
let currentLightness=80;
let dragging=false;

function updatePreviewFromHSL(h,l){
 const hex=hslToHex(h,70,l);
 hexInput.value=hex.replace('#','').toUpperCase();

 const {h:hh,s, l:ll}=hexToHsl(hex);
 colorPreviewLarge.style.background=`hsla(${hh},${s}%,${ll}%,0.22)`;
 colorPreviewLarge.style.boxShadow=
    `0 0 0 1px hsla(${hh},${s}%,${ll}%,0.55) inset,`+
    `0 10px 30px hsla(${hh},${s}%,${ll}%,0.35)`;

 if(currentCategory) tempColors[currentCategory]=hex;
}

/* Move thumb and update color */
function setFromPosition(x,y){
 const rect=colorField.getBoundingClientRect();
 const clampedX=Math.max(0,Math.min(rect.width,x));
 const clampedY=Math.max(0,Math.min(rect.height,y));

 const hue=Math.round((clampedX/rect.width)*360);
 const light=Math.round((1 - clampedY/rect.height)*100);

 currentHue=hue;
 currentLightness=light;

 colorThumb.style.left=clampedX+'px';
 colorThumb.style.top=clampedY+'px';

 updatePreviewFromHSL(hue,light);
}

colorField.addEventListener('mousedown',e=>{
 dragging=true;
 const rect=colorField.getBoundingClientRect();
 setFromPosition(e.clientX-rect.left, e.clientY-rect.top);
});

document.addEventListener('mousemove',e=>{
 if(!dragging) return;
 const rect=colorField.getBoundingClientRect();
 setFromPosition(e.clientX-rect.left, e.clientY-rect.top);
});

document.addEventListener('mouseup',()=>dragging=false);

/* --- Show picker at existing color --- */
function showColorPicker(cat,hex){
 currentCategory=cat;
 const {h,l}=hexToHsl(hex);

 const rect=colorField.getBoundingClientRect();
 const x=(h/360)*rect.width;
 const y=(1 - l/100)*rect.height;

 colorThumb.style.left=x+'px';
 colorThumb.style.top=y+'px';

 updatePreviewFromHSL(h,l);
 pickerPopup.classList.add('active');
 pickerBackdrop.classList.add('active');
}

/* --- Hide picker --- */
function hideColorPicker(){
 pickerPopup.classList.remove('active');
 pickerBackdrop.classList.remove('active');
 currentCategory=null;
}

/* Hex input live update */
hexInput.addEventListener('input',e=>{
 let v=e.target.value.replace(/[^0-9a-fA-F]/g,'').toUpperCase();
 if(v.length>6)v=v.slice(0,6);
 e.target.value=v;
 if(v.length===6){
  const hex='#'+v;
  const{h,l}=hexToHsl(hex);
  const rect=colorField.getBoundingClientRect();
  colorThumb.style.left=(h/360)*rect.width+'px';
  colorThumb.style.top=(1-l/100)*rect.height+'px';
  updatePreviewFromHSL(h,l);
 }
});

pickerCancel.addEventListener('click',hideColorPicker);
pickerSave.addEventListener('click',hideColorPicker);
pickerBackdrop.addEventListener('click',hideColorPicker);

/* Open picker when clicking swatches */
document.querySelectorAll('.color-preview').forEach(p=>{
 p.addEventListener('click',()=>{
  const cat=p.dataset.category,
  v=getCSSVar(`--${cat}`),
  m=v.match(/\s*(\d+)\s*,\s*(\d+)%\s*,\s*(\d+)%/);
  if(m){
   showColorPicker(cat,hslToHex(+m[1],+m[2],+m[3]));
  }
 });
});

/* Modal open/close */
const modal=document.getElementById('color-modal'),
openBtn=document.getElementById('open-colors'),
saveBtn=document.getElementById('save-colors'),
cancelBtn=document.getElementById('cancel-colors');

let tempColors={}, tempNames={};

function showModal(s){
 modal.style.display=s?'flex':'none';
 if(s){
  tempColors={};
  tempNames={};
 }
}

openBtn.addEventListener('click',()=>showModal(true));
cancelBtn.addEventListener('click',()=>{showModal(false);hideColorPicker()});
modal.addEventListener('click',e=>{if(e.target===modal){showModal(false);hideColorPicker()}});

/* Save colors */
saveBtn.addEventListener('click',()=>{
 state.colors=state.colors||{};
 for(const k of Object.keys(tempColors)){
  const hex=tempColors[k];
  state.colors[k]=hex;
  const{h,s,l}=hexToHsl(hex);
  setCSSVar(`--${k}`,`${h}, ${s}%, ${l}%`);
 }
 save();
 showModal(false);
 hideColorPicker();
 render();
});

render();
</script>
</body>
</html>
